# üê¶ Twitt Microservice

![Java](https://img.shields.io/badge/Java-17+-blue) ![Spring Boot](https://img.shields.io/badge/Spring%20Boot-3.x-brightgreen) ![Cassandra](https://img.shields.io/badge/Cassandra-4.x-orange) ![Redis](https://img.shields.io/badge/Redis-6.x-red) ![Kafka](https://img.shields.io/badge/Kafka-3.x-yellow)

**–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–≤–∏—Ç–æ–≤: –ø—É–±–ª–∏–∫–∞—Ü–∏—è, —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –≤—ã–±–æ—Ä–∫–∞ —Å–ª—É—á–∞–π–Ω—ã—Ö —Ç–≤–∏—Ç–æ–≤.**

---

## üìö –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–ø–∏—Å–∞–Ω–∏–µ](#–æ–ø–∏—Å–∞–Ω–∏–µ)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
3. [–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è](#—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è)
4. [–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è](#–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è)
5. [–ó–∞–ø—É—Å–∫](#–∑–∞–ø—É—Å–∫)
6. [REST API](#rest-api)
7. [gRPC –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å](#grpc-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å)
8. [–°—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è](#—Å—Ü–µ–Ω–∞—Ä–∏–∏-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
9. [–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –ª–æ–≥–∏–∫–∞](#–≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è-–ª–æ–≥–∏–∫–∞)
10. [–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ —Ä–µ—Ç—Ä–∞–∏](#–æ–±—Ä–∞–±–æ—Ç–∫–∞-–æ—à–∏–±–æ–∫-–∏-—Ä–µ—Ç—Ä–∞–∏)
11. [–ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —É—è–∑–≤–∏–º–æ—Å—Ç–∏](#–∏–∑–≤–µ—Å—Ç–Ω—ã–µ-–ø—Ä–æ–±–ª–µ–º—ã-–∏-—É—è–∑–≤–∏–º–æ—Å—Ç–∏)

---

## üìù –û–ø–∏—Å–∞–Ω–∏–µ

–°–µ—Ä–≤–∏—Å –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:

* **–ü—É–±–ª–∏–∫–∞—Ü–∏—é —Ç–≤–∏—Ç–æ–≤** (REST).
* **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ** –≤ Cassandra.
* **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö** –≤ Redis –¥–ª—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ –æ—Ç–±–æ—Ä–∞.
* **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É** —Å–æ–æ–±—â–µ–Ω–∏–π –≤ Kafka (user –∏ index —Ç–æ–ø–∏–∫–∏).
* **–í—ã–±–æ—Ä–∫—É —Å–ª—É—á–∞–π–Ω—ã—Ö —Ç–≤–∏—Ç–æ–≤** (gRPC).

---

## üèó –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```text
[Client] --> [REST Controller] --> [TwittService] --> {Cassandra, Redis, Kafka}
                                   ‚Ü≥ [gRPC Service] --> [TwittService] --> Cassandra
```

* **REST Controller**: `POST /api/v1/twitt/post`
* **gRPC Service**: `GetTwitts` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è N —Å–ª—É—á–∞–π–Ω—ã—Ö —Ç–≤–∏—Ç–æ–≤
* **TwittService**: –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∏ –≤—ã–±–æ—Ä–∫–∏
* **TwittRepository**: –¥–æ—Å—Ç—É–ø –∫ Cassandra
* **RedisTemplate**: —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–ª—é—á–µ–π –¥–ª—è random selection
* **KafkaSender**: –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏–π

---

## üìã –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

* Java 17+
* Spring Boot 3.x
* Cassandra 4.x
* Redis 6.x
* Kafka 3.x
* Protobuf & gRPC

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–í `application.yml` –∏–ª–∏ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

```yaml
spring:
  kafka:
    user-topic: twitt-user-topic
    index-topic: twitt-index-topic
configs:
  redis:
    randomly-recommended-days: 7
    random-twitt-prefix: random_twitt
cassandra:
  contact-points: ...
  keyspace: twitt_keyspace
redis:
  host: localhost
  port: 6379
```

---

## ‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫

1. –°–æ–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç:

   ```bash
   mvn clean package
   ```
2. –ó–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (Cassandra, Redis, Kafka).
3. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å:

   ```bash
   java -jar target/twitt-service.jar
   ```

---

## üöÄ REST API

### –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Ç–≤–∏—Ç–∞

`POST /api/v1/twitt/post`

* **Content-Type**: `application/json`

* **–¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞**:

  ```json
  {
    "userTag": "johndoe",
    "twittId": "550e8400-e29b-41d4-a716-446655440000",
    "twittText": "Hello, world!",
    "twittHeader": "–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ",
    "twittTags": ["intro", "hello"],
    "createdAt": "2025-06-11T12:00:00"
  }
  ```

* **–û—Ç–≤–µ—Ç—ã**:

    * `200 OK` ‚Äî —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ
    * `500 Internal Server Error` ‚Äî –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏

---

## üõ∞ gRPC –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å

```proto
service GetTwitts {
  rpc GetTwitts (GetTwittRequest) returns (GetTwittReply);
}

message GetTwittRequest {
  int32 twittsNumber = 1;
}

message GetTwittReply {
  repeated Twitt twitt = 1;
}

message Twitt {
  string userTag = 1;
  string twittText = 2;
  string twittHeader = 3;
  repeated string twittTags = 4;
  google.protobuf.Timestamp createdAt = 5;
}
```

* **–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞**:

    * –í—ã–∑–æ–≤ `GetTwitts` —Å `twittsNumber = 5` –≤–µ—Ä–Ω—ë—Ç –¥–æ 5 —Å–ª—É—á–∞–π–Ω—ã—Ö —Ç–≤–∏—Ç–æ–≤.

---

## üéØ –°—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—É–±–ª–∏–∫—É–µ—Ç —Ç–≤–∏—Ç** —á–µ—Ä–µ–∑ REST.
2. **–°–µ—Ä–≤–∏—Å ¬´–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ¬ª** –ø–æ–ª—É—á–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ç–≤–∏—Ç–æ–≤ —á–µ—Ä–µ–∑ gRPC.
3. **–ú–æ–¥—É–ª—å –ø–æ–∏—Å–∫–∞** –∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–µ —Ç–≤–∏—Ç—ã, —á–∏—Ç–∞—è Kafka `index-topic`.
4. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º —á–µ—Ä–µ–∑ Kafka `user-topic`.

---

## üîç –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –ª–æ–≥–∏–∫–∞

### –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Ç–≤–∏—Ç–∞

1. –ó–∞–ø–∏—Å—å –≤ **Cassandra** (`twittRepository.save`).
2. –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª—é—á–∞ –≤ **Redis** ‚Äî `prefix:twittId` —Å TTL.
3. –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ **Kafka**:

    * **user-topic**: `{ userTag ‚Üí twittId }`
    * **index-topic**: `{ twittId, twittText, twittTags }`
4. **–†–µ—Ç—Ä–∞–∏** –ø–æ –∏—Å–∫–ª—é—á–µ–Ω–∏—è–º (3 –ø–æ–ø—ã—Ç–∫–∏, —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –±—ç–∫–æ—Ñ—Ñ).

### –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ª—É—á–∞–π–Ω—ã—Ö —Ç–≤–∏—Ç–æ–≤

1. **Scan Redis** –ø–æ —à–∞–±–ª–æ–Ω—É `prefix*`, —Å–æ–±–∏—Ä–∞—è UUID.
2. **–ù–∞–±–æ—Ä –¥–æ N –∫–ª—é—á–µ–π**.
3. **–ó–∞–ø—Ä–æ—Å –≤ Cassandra** `findAllByTwittIdIn`.
4. **–û—Ç–ø—Ä–∞–≤–∫–∞** —Å–ø–∏—Å–∫–∞ —Ç–≤–∏—Ç–æ–≤ –∫–ª–∏–µ–Ω—Ç—É.

---

## üõ† –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ —Ä–µ—Ç—Ä–∞–∏

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç       | –ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ                       | –†–µ—Ç—Ä–∞–π                  |
| --------------- | ------------------------------------------ | ----------------------- |
| Cassandra Write | –ò—Å–∫–ª—é—á–µ–Ω–∏–µ ‚Üí –ª–æ–≥ ‚Üí `@Retryable`            | 3 –ø–æ–ø—ã—Ç–∫–∏, backoff 1s√ó2 |
| Redis Write     | –ò—Å–∫–ª—é—á–µ–Ω–∏–µ ‚Üí `RedisException` ‚Üí 500 –æ—Ç–≤–µ—Ç  | –ù–µ—Ç                     |
| Kafka Send      | –õ–æ–≥ –æ—à–∏–±–∫–∏, –±–µ–∑ —Ä–µ—Ç—Ä–∞—è (fire-and-forget)   | –ù–µ—Ç                     |
| gRPC Scan       | –ò—Å–∫–ª—é—á–µ–Ω–∏–µ ‚Üí `RedisException` (gRPC error) | –ù–µ—Ç                     |

---

## ‚ö†Ô∏è –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —É—è–∑–≤–∏–º–æ—Å—Ç–∏

1. **–§–∏–∫—Ç–∏–≤–Ω—ã–π `userTag`** –≤ gRPC  ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è "TEST\_TAG" –≤–º–µ—Å—Ç–æ —Ä–µ–∞–ª—å–Ω–æ–≥–æ.
2. **Null-–∫–ª—é—á –≤ Kafka** ‚Äî `ProducerRecord(key=null)`, –ø–ª–æ—Ö–æ–π —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ.
3. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏** REST DTO (–Ω–µ—Ç –∞–Ω–Ω–æ—Ç–∞—Ü–∏–π `@Valid`).
4. **Blocking Scan** –≤ Redis –±–µ–∑ –ø–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–æ–≥–æ –æ–±—Ö–æ–¥–∞ ‚Üí –ø–æ–¥–≤–∏—Å–∞–Ω–∏–µ –Ω–∞ –±–æ–ª—å—à–∏—Ö –æ–±—ä—ë–º–∞—Ö.
5. **TTL –±–µ–∑ —É—á—ë—Ç–∞ –∑–∞–¥–µ—Ä–∂–µ–∫** –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø–æ—Ç–µ—Ä–µ –∫–ª—é—á–µ–π –¥–æ –ø—Ä–æ—á—Ç–µ–Ω–∏—è.
6. **–ù–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏/–ª–∏–º–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏—è** –¥–æ—Å—Ç—É–ø–∞ –∫ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞–º.
7. **–ò–∑–±—ã—Ç–æ—á–Ω—ã–µ catch-all** –±–ª–æ–∫–∏ —Ä–∞—Å–∫—Ä—ã–≤–∞—é—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –¥–µ—Ç–∞–ª–∏.
8. **–†–µ—Ç—Ä–∞–π –Ω–∞ –≤—Å–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è** ‚Äî —Ä–µ—Ç—Ä–∞–∏—Ç—å client‚Äìerrors –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω–æ.
9. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –º–µ—Ç—Ä–∏–∫**: –Ω–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ latency/fail rates.
10. **–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π NPE** –ø—Ä–∏ `twittTags == null`.

---

*–ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏ –∏—Å–ø—Ä–∞–≤—å—Ç–µ –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.*
